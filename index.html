<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Ronda</title>
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery & Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="container mt-4">
    <div class="d-flex align-items-center justify-content-center" style="margin: 5px; padding: 5px; border-radius: 10px; background-color: #E8F5E9;">
        <img src="assets/img/logo.png" style="height: auto; max-height: 100px; margin-right: 10px;" />
        <h4 class="text-success" style="line-height: 40px; margin-bottom: 0;"><b>Presensi Ronda</b></h4>
    </div>

    <div class="row" style="border-radius: 10px; background-color: #E0F2F1; margin: 5px; padding: 5px;">
        <form id="presensiForm" class="p-4">
            <div class="col-md-12 mb-3">
                <h3 class="text-success text-center" id="tanggal-sekarang"></h3>

                <input type="date" class="form-control" style="display: none;" id="tanggal" >
            </div>
            <div class="col-md-12 mb-3">
                <label for="nomor_rumah">Nomor Rumah:</label>
                <select id="nomor_rumah" class="form-control">
                    <option value="">Piih Rumah</option>
                    <option value="1">1 - Hartono</option>
                    <option value="2">2 - Yuliyanto</option>
                    <option value="3">3 - (belum diisi nama)</option>
                    <option value="4">4 - Wahyono</option>
                    <option value="5">5 - Doni</option>
                    <option value="6">6 - Rizky</option>
                    <option value="7">7 - (belum diisi nama)</option>
                    <option value="8">8 - Hendra</option>
                    <option value="9">9 - Bambang</option>
                    <option value="10">10 - (belum diisi nama)</option>
                    <option value="11">11 - Herma</option>
                    <option value="12">12 - (belum diisi nama)</option>
                    <option value="13">13 - (belum diisi nama)</option>
                    <option value="14">14 - (belum diisi nama)</option>
                    <option value="15">15 - Eko</option>
                    <option value="16">16 - Farid</option>
                    <option value="17">17 - (belum diisi nama)</option>
                    <option value="18">18 - Rini</option>
                    <option value="19">19 - Adi</option>
                    <option value="20">20 - Pak Roni</option>
                    <option value="21">21 - Yudha</option>
                    <option value="22">22 - Ineke</option>
                    <option value="23">23 - (belum diisi nama)</option>
                    <option value="24">24 - (belum diisi nama)</option>
                    <option value="25">25 - Nugroho</option>
                    <option value="26">26 - Agus</option>
                    <option value="27">27 - (belum diisi nama)</option>
                    <option value="28">28 - Ade</option>
                    <option value="29">29 - (belum diisi nama)</option>
                    <option value="30">30 - Wahyu Sutejo</option>
                    <option value="31">31 - Amri</option>
                    <option value="32">32 - Dedy</option>
                    <option value="33">33 - Roni</option>
                    <option value="34">34 - Joko</option>
                    <option value="35">35 - Sinyo/Aang</option>
                    <option value="36">36 - (belum diisi nama)</option>
                    <option value="37">37 - Ulil</option>
                    <option value="38">38 - Ardi/Adinda</option>
                    <option value="39">39 - Boby</option>
                    <option value="40">40 - Hari</option>
                    <option value="41">41 - (belum diisi nama)</option>
                    <option value="42">42 - (belum diisi nama)</option>
                    <option value="43">43 - Farah</option>
                    <option value="44">44 - Wahyu</option>
                    <option value="45">45 - (belum diisi nama)</option>
                    <option value="46">46 - (belum diisi nama)</option>
                    <option value="47">47 - (belum diisi nama)</option>
                    <option value="48">48 - Sari</option>
                    <option value="49">49 - (belum diisi nama)</option>
                    <option value="50">50 - Hafidz</option>
                    <option value="51">51 - Koko</option>
                    <option value="52">52 - Tri/Yudi</option>
                    <option value="53">53 - Anwar</option>
                    <option value="54">54 - Okta</option>
                    <option value="55">55 - (belum diisi nama)</option>
                    <option value="56">56 - (belum diisi nama)</option>
                    <option value="57">57 - (belum diisi nama)</option>
                    <option value="58">58 - (belum diisi nama)</option>
                    <option value="59">59 - Pitaloka</option>
                    <option value="60">60 - Tri</option>
                    <option value="61">61 - Royhan</option>
                    <option value="62">62 - Samsino</option>
                    <option value="63">63 - Kasto</option>
                    <option value="64">64 - Wahyu Hidayat</option>
                    <option value="65">65 - Yahya</option>
                    <option value="66">66 - Zaky</option>
                    <option value="67">67 - Endra</option>
                    <option value="68">68 - Ikhwan</option>
                </select>

            </div>
            <div class="col-md-12 mb-3">
                <label class="form-label">Kehadiran</label>
                <select class="form-select" id="kehadiran">
                    <option value="H">Hadir</option>
                    <option value="I">Ijin</option>
                </select>
            </div>
            <button type="button" class="btn btn-lg btn-success w-100" onclick="kirimPresensi()">SIMPAN PRESENSI</button>
            <br/><hr/><br/>
            <h3 class="text-center text-success">Presensi Hari Ini</h3>
            <div class="col-md-12 mb-3">
                <table border="1" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Nomor Rumah</th>
                            <th>Nama</th>
                            <th>Kehadiran</th>
                            <th>Waktu Absen</th>
                        </tr>
                    </thead>
                    <tbody id="presensi-hari-ini">
                        <tr><td colspan="5">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </form>


    </div>
    <script>
        $('#nomor_rumah').select2({
            placeholder: "Pilih Nomor Rumah",
            allowClear: true
        });

        // waktuBolehPresensi()
        function waktuBolehPresensi(){
            // ‚úÖ 1. Cek Jam Saat Ini
            let now = new Date();
            let hoursNow = now.getHours();
            let minutesNow = now.getMinutes();

            let waktuSekarang = hoursNow * 60 + minutesNow;
            let batasAwal = 21 * 60 + 30; // 21:30 (setengah 10 malam)
            let batasAkhir = 5 * 60; // 05:00 pagi

            // ‚úÖ 2. Jika belum jam 21:30, tampilkan peringatan & hentikan proses
            if (!(waktuSekarang >= batasAwal || waktuSekarang <= batasAkhir)) {
                Swal.fire({
                    title: "Gasik men bolo",
                    text: "Ronda ne dimulai soko setengah 10, urung wayahe",
                    allowOutsideClick: false, // üîí Tidak bisa ditutup dengan klik luar
                    allowEscapeKey: false,    // üîí Tidak bisa ditutup dengan tombol Escape
                    allowEnterKey: false,     // üîí Tidak bisa ditutup dengan tombol Enter
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                return;
            }
        }

        const urlScript = 'https://script.google.com/macros/s/AKfycbwe-TlWr93pSj8N2xeAoOqjjbhJJnxORx25P4qBH_9PZLvtjUrQ307bVSLoNomiIx7NJw/exec';

        const date = new Date();
        // document.getElementById('tanggal').valueAsDate = date;
        const formattedDateToday = date.toLocaleDateString('en-CA');  // Format as YYYY-MM-DD
        $('#tanggal').val(formattedDateToday);

        console.log($('#tanggal').val())
        // Parse the tanggal_input to a Date object

        // Get the day, month, year, hours, minutes, and seconds
        const dayOfWeek = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"][date.getDay()];
        const day = String(date.getDate()).padStart(2, '0'); // Adds leading zero if needed
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed, so +1
        const monthName = new Intl.DateTimeFormat("id-ID", { month: "long" }).format(date);
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0'); // Hours
        const minutes = String(date.getMinutes()).padStart(2, '0'); // Minutes
        const seconds = String(date.getSeconds()).padStart(2, '0'); // Seconds

        // Format the date as "tanggal-bulan-tahun jam:menit:detik"
        const formattedDate = `${dayOfWeek}, ${day} ${monthName} ${year} ${hours}:${minutes}:${seconds} WIB`;
        $('#tanggal-sekarang').html(formattedDate)

        function loadPresensiHariIni() {
            document.getElementById("presensi-hari-ini").innerHTML = "<tr><td colspan='5'>Memuat ulang data...</td></tr>";
            fetch(urlScript)
            .then(response => response.json())
            .then(data => {
                console.log("Data diterima:", data);

                if (!Array.isArray(data)) {
                    console.error("Response bukan array!", data);
                    document.getElementById("presensi-hari-ini").innerHTML = "<tr><td colspan='5'>Error: Data tidak valid.</td></tr>";
                    return;
                }

                let tableBody = document.getElementById("presensi-hari-ini");
                tableBody.innerHTML = "";

                if (data.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='5'>Belum ada presensi hari ini.</td></tr>";
                    return;
                }

                data.forEach(row => {
                    let tr = document.createElement("tr");

                    // Parse the tanggal_input to a Date object
                    const date = new Date(row.tanggal_input);

                    // Get the day, month, year, hours, minutes, and seconds
                    const day = String(date.getDate()).padStart(2, '0'); // Adds leading zero if needed
                    const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed, so +1
                    const year = date.getFullYear();
                    const hours = String(date.getHours()).padStart(2, '0'); // Hours
                    const minutes = String(date.getMinutes()).padStart(2, '0'); // Minutes
                    const seconds = String(date.getSeconds()).padStart(2, '0'); // Seconds

                    // Format the date as "tanggal-bulan-tahun jam:menit:detik"
                    const formattedDate = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;

                    tr.innerHTML = `
                        <td>${row.nomor_rumah}</td>
                        <td>${row.pemilik}</td>
                        <td>${row.kehadiran}</td>
                        <td>${formattedDate}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            })
            .catch(error => {
                console.error("Gagal mengambil data!", error);
                document.getElementById("presensi-hari-ini").innerHTML = "<tr><td colspan='5'>Gagal memuat data.</td></tr>";
            });
        }

        // Panggil fungsi saat halaman dimuat
        document.addEventListener("DOMContentLoaded", loadPresensiHariIni);

        async function kirimPresensi() {
            Swal.fire({
                title: "Menyimpan...",
                text: "Harap tunggu sebentar",
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            let canSubmit = await checkDuplicateBeforeSubmit();
            if (!canSubmit) return; // Jika duplikat, hentikan proses

            if(document.getElementById("nomor_rumah").value == ''){
                Swal.fire({
                    title: "Kurang tepat!",
                    text: "Nomor rumah harus diisi",
                    icon: "error",
                    confirmButtonText: "Coba Lagi"
                });
                return;
            }

            if(document.getElementById("nomor_rumah").value > 68 || document.getElementById("nomor_rumah").value < 1){
                Swal.fire({
                    title: "Kurang tepat!",
                    text: "Nomor Rumah harus 1-68",
                    icon: "error",
                    confirmButtonText: "Coba Lagi"
                });
                return;
            }



            fetch(urlScript, {
                method: "POST",
                mode: "no-cors",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    tanggal: document.getElementById("tanggal").value,
                    nomor_rumah: document.getElementById("nomor_rumah").value,
                    kehadiran: document.getElementById("kehadiran").value
                })
            })
            .then(() => {

                Swal.fire({
                    title: "Berhasil!",
                    text: "Data presensi telah tersimpan.",
                    icon: "success",
                    confirmButtonText: "OK"
                });

                // Kosongkan form
                // document.getElementById("tanggal").value = "";
                // document.getElementById("nomor_rumah").value = "";
                // document.getElementById("kehadiran").value = "";
                $('#nomor_rumah').val('').change()

                // üî• Perbarui tabel setelah submit
                loadPresensiHariIni();
            })
            .catch(error => {
                console.error("Gagal mengirim presensi!", error);
                Swal.fire({
                    title: "Gagal!",
                    text: "Terjadi kesalahan saat menyimpan data.",
                    icon: "error",
                    confirmButtonText: "Coba Lagi"
                });
            });

        }

        async function checkDuplicateBeforeSubmit() {
            const tanggalInput = document.getElementById("tanggal").value;
            const nomorRumahInput = document.getElementById("nomor_rumah").value;

            try {
                // üîπ Ambil data presensi hari ini dari Google Sheets
                const response = await fetch(urlScript);
                const data = await response.json();

                console.log("Data dari Google Sheets:", data); // Debugging

                // üîπ Format ulang tanggal input agar sama dengan yang ada di Google Sheets
                const formattedTanggalInput = new Date(tanggalInput).toISOString().split("T")[0]; // Format YYYY-MM-DD

                // üîπ Cek apakah nomor rumah sudah ada di tanggal yang sama
                const isDuplicate = data.some(row => {
                    const formattedTanggalSheet = new Date(row.tanggal).toISOString().split("T")[0];
                    return formattedTanggalSheet === formattedTanggalInput && Number(row.nomor_rumah) === Number(nomorRumahInput);
                });

                if (isDuplicate) {
                    Swal.fire("Gagal!", "Nomor rumah sudah absen pada tanggal ini!", "error");
                    return false; // ‚ùå Batalkan submit
                }
                return true; // ‚úÖ Lanjutkan submit
            } catch (error) {
                Swal.fire("Error!", "Gagal mengambil data: " + error, "error");
                return false;
            }
        }


    </script>
</body>
</html>
